cd simulations/results;

in_dir = '/media/joebillingsley/Data/projects/NFV_FatTree/simulations/results';
out_dir = '/media/joebillingsley/Data/projects/NFV_FatTree/out/data';

test_problems = dir;
test_problems = test_problems(~ismember({test_problems.name},{'.','..', 'parameters'}));

file_runs = zeros(length(test_problems), 1);

test_group_ptrn = '-';

for i = 1 : length(test_problems)
    temp = regexp(test_problems(i).name, test_group_ptrn, 'split');
    test_groups(i) = temp(1);
end

test_groups = unique(test_groups);

param_ptrn = '(?<=-)[0-9.]*(?=-)';
mean_ptrn = '(?<=scalar FatTree Time_In_System:mean )([0-9.]*|-nan|nan)';

for i = 1 : length(test_groups)
    test_group = test_groups{i};
    test_files = dir([test_group, '*']);
    
    for j = 1 : size(test_files, 1)
        
        test_file = test_files(j);
        arr_rate = extract_arrival_rate(test_file.name);
                
        if strcmp(test_group, 'DifferentLengths')
            
            [num_services, lengths, vnfs] = extract_services(test_file.name);
            out_fname = [test_group '_' num2str(lengths(1))];
            
        elseif strcmp(test_group, 'FilteringVNFs')
            
            [num_services, lengths, vnfs] = extract_services(test_file.name);
            out_fname = [test_group '_' num2str(vnfs(end))];
            
            if vnfs(end) == 80
                
                blah = 2;
            end
            
        elseif strcmp(test_group, 'IncreasingNumPorts')
            
            
            
        elseif strcmp(test_group, 'IncreasingSDN')
            
        elseif strcmp(test_group, 'MultipleServices')
            
        else
            error("No match for test group %s", test_group);
        end
        
        fread = fullfile(in_dir, test_files(j).name);
        fread = fileread(fread);
                
        mean = regexp(fread, mean_ptrn, 'match');
        mean = str2double(mean);
        
        fwrite = fullfile(out_dir, ['SIMULATION_' out_fname '.out']);
        fwrite = fopen(fwrite, 'a');
        
        fprintf(fwrite, '%f %f \n', arr_rate, mean);
        
        fclose(fwrite);
    end
    
end

function arrival_rate = extract_arrival_rate(str)
dash_pos = strfind(str, '-');
comma_pos = strfind(str, ',');

arrival_rate = str(dash_pos(1)+1:comma_pos(1)-1);
arrival_rate = str2double(arrival_rate);
end

function [num_services, lengths, vnfs] = extract_services(str)

dash_pos = strfind(str, '-');
comma_pos = strfind(str, ',');

services = str(comma_pos(1)+1:dash_pos(2)-1);
services = strsplit(services, '_');

num_services = length(services);

for i=1:num_services
    vnf_str = strsplit(services{i}, '.');
    lengths(i) = length(vnf_str);
    
    for j=1:lengths(i)
        vnfs(i,j) = str2double(vnf_str(j));
    end
end

end

function parameter = extract_parameter(str)

dash_pos = strfind(str, '-');
comma_pos = strfind(str, ',');

parameter = str(comma_pos(1)+1:dash_pos(2)-1);
parameter = str2double(parameter);

end